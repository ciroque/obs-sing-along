  <!DOCTYPE html>
<html lang="us-en">
<head>
    <script>
	const sourceChannel = new BroadcastChannel('obs-sing-along-source-channel');
	const panelChannel = new BroadcastChannel('obs-sing-along-panel-channel');
	
	panelChannel.onmessage = (ev) => singAlong.handleControlEvent(ev);
	
	class SingAlong {
		song = null;
		currentVerseIndex = 0;
		verseCount = 0;
		
		loadSong(song) {
			this.song = song;
			this.verseCount = song.lines.length;
			sourceChannel.postMessage({name: "SONG-LOADED", verseCount: this.verseCount});
      this.selectVerse(0);
      this.showTitle();
		};
		
		selectVerse(index) {
			if(index >= 0 && index < this.verseCount) {
				this.currentVerseIndex = index;
				this.showVerse();
			} else {
				alert(`The given verse index is out of range! ${index}`);
				console.error(`The given verse index is out of range! ${index}`);
			}
		};
		
		showTitle() {
      const num = this.song.number ? `#${this.song.number}:` : "";
			document.getElementById("title").innerText = `${num} ${this.song.name}`;
		};
		
		showVerse() {
      const ele = document.getElementById("lyrics");
      ele.className = "fade";
			var innerHtml = `<div>${this.song.lines[this.currentVerseIndex]}</div>`;
      
      function updateAndFadeIn() {
        ele.innerHTML = innerHtml;
        ele.className = "";
      }
      
      
      window.setTimeout(updateAndFadeIn, 250);
		};
		
		prevVerse() {
			this.changeVerse(-1);
			this.showVerse();
		};

		nextVerse() {
			this.changeVerse(1);
			this.showVerse();
		};
		
		changeVerse(offset) {
			this.currentVerseIndex = (this.currentVerseIndex + offset + this.verseCount) % this.verseCount;
			sourceChannel.postMessage({name: "VERSE-SELECTED", selectedVerse: this.currentVerseIndex + 1});
		};
		
		listVerses() {
			this.song.verses;
		};
		
		handleControlEvent(ev) {
			console.log(`Sing Along browser source received a message: ${JSON.stringify(ev.data, null, 3)}`);
			
			const {name, song, index} = ev.data;
			
      switch(name) {
				case "LOAD-SONG": {
          singAlong.loadSong(song);
					break;
				}
				
				case "NEXT-VERSE": {
					console.log("Moving to next verse");
					singAlong.nextVerse();
					break;
				}
				
				case "PREV-VERSE": {
					console.log("Moving to previous verse");
					singAlong.prevVerse();
					break;
				}

				case "SELECT-VERSE": {
					console.log(`Selecting verse ${index}`);
					singAlong.selectVerse(index);
					break;
				}

				default: {
					console.log(`Sing Along source received a message: ${JSON.stringify(ev.data, null, 3)}`);
					break;
				}
			}
		}
	}
	
	const hymn = {
    number: 67,
		title: "Glory to God on High", 
		verses: [
      "Glory to God on high! Let heav’n and earth reply. Praise ye his name. His love and grace adore, Who all our sorrows bore. Sing aloud evermore: Worthy the Lamb!",
      "Jesus, our Lord and God, Bore sin’s tremendous load. Praise ye his name. Tell what his arm has done, What spoils from death he won. Sing his great name alone: Worthy the Lamb!",
      " Let all the hosts above Join in one song of love, Praising his name. To him ascribed be Honor and majesty, Thru all eternity: Worthy the Lamb!"
		]
	}

	const hymn2 = {
		title: "Glory to God on High", 
		verses: [
      "Glory to God on high! Let heav’n and earth reply. Praise ye his name. His love and grace adore, Who all our sorrows bore. Sing aloud evermore: Worthy the Lamb!",
      "Jesus, our Lord and God, Bore sin’s tremendous load. Praise ye his name. Tell what his arm has done, What spoils from death he won. Sing his great name alone: Worthy the Lamb!",
      " Let all the hosts above Join in one song of love, Praising his name. To him ascribed be Honor and majesty, Thru all eternity: Worthy the Lamb!"
		]
	}
    </script>
    <style>
    html, body { 
      width: 100%; 
      overflow: hidden; 
    }
    html { height: 360px; }
    body {
      background-color: rgb(42, 42, 42, 0.75);
      color: #F2F2F2;
      font-family: Arial;
      min-height: 100%;
    }
    
    header {
      font-size: 48pt;
      margin-bottom: 0.25em;
    }
    
    article {
      font-size: 42pt;
      margin-left: 0.5em;
      margin-right: 0.5em;
    }
    
    article#lyrics {
      opacity: 1;
      -webkit-transition: opacity 025s;
      -moz-transition: opacity 0.25s;     
      transition: opacity 0.25s; 
    }

    article#lyrics.fade {
      opacity: 0;
    }    
    </style>
    <title>Sing Along</title>
</head>
<body>
	<main>
		<header id="title"></header>
		<article id="lyrics"></article>
	</main>
	
	<script>
	const singAlong = new SingAlong();
	document.SingAlong = singAlong;
	</script>
</body>
</html>
